$(function() {

    'use strict';

    var $body       = $('body'),
        $header     = $('header'),
        $overlay    = $('#overlay'),
        $window     = $(window);

    /**
     * main navigation
     */
    $('a[href*="#"]')
    .not('[href="#"]')
    .click(function(event) {
        if (
            location.pathname.replace(/^\//, '') === this.pathname.replace(/^\//, '') &&
            location.hostname === this.hostname
        ) {
            var target = $(this.hash);
            target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
            if (target.length) {
                event.preventDefault();
                $('html, body').stop().animate({
                    scrollTop: $(target).offset().top - 80 /* menu height */
                }, 700);
            }
        }
    });

    if ($('[data-page]').data('page') === 'home') {
        var topmenu_offset = $('header').outerHeight();

        $window.on('scroll', function(event) {
            var scrollPos = $(document).scrollTop(),
                menu_links = $('header .nav-link'),
                actual_link = menu_links.first();

            menu_links.each(function () {
                var currLink = $(this);
                var refElement = $(currLink.attr("href"));
                if (
                    !!refElement.length
                    && refElement.position().top <= scrollPos + topmenu_offset
                    // && refElement.position().top + refElement.outerHeight() > scrollPos + topmenu_offset
                ) {
                    actual_link = currLink;
                }
            });

            menu_links.removeClass("active");
            actual_link.addClass("active");
        }).trigger('scroll');
    }

    /**
     * open share popup / mobile menu popup
     */
    var $shareOpen = $('.header-share-open'),
        $navPopupWrapper = $('.nav-popup-wrapper');

    $shareOpen.on('click', function(e) {
        e.preventDefault();
        $('#overlay').addClass('active');
        $navPopupWrapper.addClass('active');
    });

    /**
     * mobile menu
     * close overlay when clicking a link
     */
    $('.nav-popup').on('click', '[data-scroll-to]', function(e) {
        e.preventDefault();

        $overlay.removeClass('active');
        $navPopupWrapper.removeClass('active');
    });

    /**
     * countdown
     */
    var $countdown = $('.countdown');
    if ($countdown.length) {
        var date,
            dateArr;


        $.ajax({
            url: base_url + '/fair-datetime',
            type: 'get',
            data : {timestamp: $countdown.data('date'), timezone: jstz.determine().name()},
            dataType: 'text',
            async: false,
            success: function(data) {
                date = data;
            }
        });


        dateArr = date.split(/[^0-9]/),
        date = new Date(dateArr[0],dateArr[1]-1,dateArr[2],dateArr[3],dateArr[4],dateArr[5]);


        $countdown.countdown({
            padZeroes: true,
            until: date,
            labels: translations.common.countdown,
            onExpiry: onExpiryCountdown
        });
    }

    function onExpiryCountdown() {
        location.reload(true);
    }

    /**
     * change language
     */
    $('.change-language').on('click', function(e) {
        e.preventDefault();

        if ($('.nav-popup-wrapper').hasClass('active')) {
            $('.nav-popup-wrapper').find('.popup-close').click();
        }

        openPopupLang();
    });

    function openPopupLang() {
        $('.popup-languages').addClass('active');
        $overlay.addClass('active');
    }

    /**
     * faq
     */
    $('.accordion').on('click', '.header', function(e) {
        e.preventDefault();
        $('.accordion .accordion-pane').removeClass('active');
        $(this).parent('.accordion-pane').addClass('active');
    });

    /**
     * tooltip
     */
    $('[data-toggle="tooltip"]').on('click', function(e) {
        e.preventDefault();
    });

    $('[data-toggle="tooltip"]').tooltip();

    $('[data-toggle="tooltip"]').on('shown.bs.tooltip', function(e) {
        var $tooltip = $(e.target)
        $tooltip.one('click', function(e) {
            $tooltip.tooltip('hide');
        });
    });

    /**
     * Direct link to registration popup
     */
    if (window.location.hash === '#register') {
        var $registerButton = $('*[data-action="subscribe"]:first');

        if ($registerButton.length) {
            $registerButton.click();
        }
    }


    /**
     * After registration, if the user is pending, open the popup with information
     */
    if (window.location.hash === '#registered') {
        // var $pendingButton = $('*[data-action="showpending"]:first');

        // if ($pendingButton.length) {
        //     $pendingButton.click();
        // }
        showAlertStep2(translate('registration.step2.thanks'), translate('registration.step2.confirmed-successfully-save'));
    }

    /**
     * After registration, if the user is pending, open the popup with information
     */
    if (window.location.hash === '#pregistered') {
        // var $pendingButton = $('*[data-action="showpending"]:first');

        // if ($pendingButton.length) {
        //     $pendingButton.click();
        // }
        showAlertStep2(translate('registration.step2.thanks'), translate('registration.step2.pending-successfully-save'));
    }

    /**
     * Full height banner
     */
    var MOBILE_BREAKPOINT = 550,
        resizeTimer,
        $banner = $('#banner');

    var onResize = function () {
        var wWidth = $window.width();
        var wHeight = $window.height();
        var headerHeight = $('body > header').outerHeight();
        var barWhenHeight = $('.bar-when').outerHeight();

        $window.trigger('scroll');

        if (wWidth < MOBILE_BREAKPOINT) {
            $banner.css('height', '');
        } else {
            $banner.css('height', wHeight - headerHeight - barWhenHeight);
        }
    };

    $window.on({
        'resize': function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(onResize, 100);
        }
    }).trigger('resize');

    /**
     * Testimonial carousel
     */
    $("#testimonial-carousel").owlCarousel({
        slideSpeed : 300,
        paginationSpeed : 400,
        singleItem: true
    });

    $("#testimonial-carousel-mobile").owlCarousel({
        slideSpeed : 300,
        paginationSpeed : 400,
        singleItem: true
    });

    /**
     * iOS hack: Add an optgroup to every select in order to avoid truncating the content
     */
    if (navigator.userAgent.match(/(iPad|iPhone|iPod)/i)) {
        var selects = document.querySelectorAll("select");
        for (var i = 0; i < selects.length; i++ ){
            selects[i].appendChild(document.createElement("optgroup"));
        }
    }

});

$(function() {

    var $body       = $('body'),
        $popup      = $('.popup'),
        $overlay    = $('#overlay');


    /**
     * click on overlay
     */
    $overlay.on('click', function (e) {
        e.preventDefault();

        // only works if there's just one popup opened
        if ($('.popup.active').length === 1) {
            $body.removeClass('no-scroll');
            $popup.removeClass('active');
            $overlay.removeClass('active');
        }
    });


    /**
     * close any popup by clicking on the X or ok button
     * [including the exhibitor's popup that's dinamically loaded]
     */
    $popup.add('.exhibitors').on('click', '.popup-close, .btn-close', function (e) {
        e.preventDefault();

        $body.removeClass('no-scroll');
        $(this).parents('.popup').removeClass('active');

        // if there isn't any other opened popup...
        if (!$('.popup.active').length) {
            $overlay.removeClass('active');
        }
    });


    /**
     * change to login/registration form on popup
     */
    $('.popup-link-change').on('click', function (e) {
        e.preventDefault();
        $('#popup-register').find('.popup-wrapper').toggleClass('deactive');

        setTimeout(function() {
            $('#popup-register').find('.popup-back').toggleClass('hidden');
        }, 1000);
    });


    /**
     * open generic content popup
     */
    $body.on('click', '[data-popup-url]', function(e) {
        e.preventDefault();

        var $this = $(this);

        $.get($this.data('popup-url'), {}, function (html) {
            $('#popup-generic').find('.popup-wrapper').html(html);
            openPopup('generic');

            $this.blur();
        });

    });

});


/**
 * Show popup with alert message
 */
function showAlert(title, message) {
    $.get(base_url + '/content/alert', {'title': title, 'message': message}, function(html) {
        html = html + '<a href="#" class="btn-close btn btn-blue">OK</a>';
        $('#popup-generic').find('.popup-wrapper').html(html);
        openPopup('generic');
    });
}

/**
 * Show popup with alert message
 */
function showAlertStep2(title, message) {
    $.get(base_url + '/content/alertStep2', {'title': title, 'message': message}, function(html) {
        html = html + '<a href="#" class="btn-close btn btn-blue">OK</a>';
        $('#popup-generic').find('.popup-wrapper').html(html);
        openPopup('generic');
    });
}


/**
 * Open a specific popup
 */
function openPopup(popup) {
    popup = (typeof popup !== 'undefined') ? popup : 'register';

    $('body').addClass('no-scroll');
    $('#overlay').addClass('active');
    $('#popup-'+popup).addClass('active');
}


/**
 * Close a specific popup
 */
function closePopup(popup) {
    popup = (typeof popup !== 'undefined') ? popup : 'register';

    $('body').removeClass('no-scroll');
    $('#popup-'+popup).removeClass('active');

    // if there isn't any other opened popup
    if (!$('.popup.active').length) {
        $('#overlay').removeClass('active');
    }
}

$(function() {
    var share_title = encodeURIComponent(translate('share.meta-title')),
        share_text  = encodeURIComponent(translate('share.meta-desc')),
        share_img   = encodeURIComponent($('meta[property="og:image"]').attr('content')),
        share_url   = encodeURIComponent($('meta[property="og:url"]').attr('content'));

    $('.share-popup').on('click', '[id^="share-"]', function(e) {
        e.preventDefault();

        var window_url,
            window_name = this.text;

        switch (this.id) {
            case "share-fb":
                window_url  = 'http://www.facebook.com/sharer.php?u='+share_url+'&p[title]='+share_title;
                break;
            case "share-tw":
                // https://dev.twitter.com/web/tweet-button/web-intent
                share_title_twitter = encodeURIComponent(translate('share.twitter-text'));
                if (!share_title_twitter) {
                    share_title_twitter = share_title;
                }
                window_url = "http://twitter.com/intent/tweet?url="+share_url+"&text="+share_title_twitter;
                break;
            case "share-gp":
                // https://developers.google.com/+/web/share/#sharelink
                window_url = 'https://plus.google.com/share?url='+share_url;
                break;
            case "share-li":
                // https://developer.linkedin.com/docs/share-on-linkedin
                window_url = 'https://www.linkedin.com/shareArticle?mini=true&url='+share_url+'&title='+share_title+'&summary='+share_text;
                break;
            case "share-pr":
                window_url  = 'http://pinterest.com/pin/create/button/?url='+share_url+'&description='+share_title+' :: '+share_text+'&media='+share_img;
                break;
        }

        window.open(window_url, window_name, windowFeatures());
    });

    $('#popup-generic').on('click', '[id^="share-"]', function(e) {
        e.preventDefault();

        var window_url,
            window_name = this.text;

        switch (this.id) {
            case "share-wa":
                share_title_twitter = encodeURIComponent(translate('share.twitter-text'));
                window_url  = 'whatsapp://send?text='+share_title_twitter+' '+share_url;
                break;
            case "share-fb":
                window_url  = 'http://www.facebook.com/sharer.php?u='+share_url+'&p[title]='+share_title;
                break;
            case "share-tw":
                // https://dev.twitter.com/web/tweet-button/web-intent
                share_title_twitter = encodeURIComponent(translate('share.twitter-text'));
                if (!share_title_twitter) {
                    share_title_twitter = share_title;
                }
                window_url = "http://twitter.com/intent/tweet?url="+share_url+"&text="+share_title_twitter;
                break;
            case "share-gp":
                // https://developers.google.com/+/web/share/#sharelink
                window_url = 'https://plus.google.com/share?url='+share_url;
                break;
            case "share-li":
                // https://developer.linkedin.com/docs/share-on-linkedin
                window_url = 'https://www.linkedin.com/shareArticle?mini=true&url='+share_url+'&title='+share_title+'&summary='+share_text;
                break;
            case "share-pr":
                window_url  = 'http://pinterest.com/pin/create/button/?url='+share_url+'&description='+share_title+' :: '+share_text+'&media='+share_img;
                break;
        }

        window.open(window_url, window_name, windowFeatures());
    });

    var windowFeatures = function (width, height) {
        width = (typeof width !== 'undefined') ?  width : 600;
        height = (typeof height !== 'undefined') ?  height : 600;

        var features = 'toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no';

        return features + ',width=' + width + ',height=' + height;
    };
});

$(function() {

    'use strict';

    var $window  = $(window),
        $body    = $('body'),
        $overlay = $('#overlay'),
        $loading = $('.exhibitors .loading');


    var $ePopup,
        $ePopupActive;


    var loadExhibitor = function(exhibitor_id) {

        preOpenPopupExhibitor();

        var $exhibitor = $('.exhibitors [data-exhibitor-id="'+exhibitor_id+'"]');

        $ePopup = $exhibitor.next('.popup');

        if(!$ePopup.length) {

            $.ajax({
                url: base_url+'/exhibitor/'+exhibitor_id,
                dataType: 'html'

            }).done(function(response) {

                if(response) {
                    $exhibitor.after(response);
                    $ePopup = $exhibitor.next('.popup');
                }

            }).always(function() {
                openPopupExhibitor();
            });

        } else {
            openPopupExhibitor();
        }

    };


    var loadExhibitors = function(virtual_fair_id) {
        if ($('.exhibitors').length) {
            var url  = base_url + '/exhibitors',
                data = {};

            if (typeof virtual_fair_id !== 'undefined') {
                url += '/'+virtual_fair_id;
            }

            $.ajax({
                url: url,
                data: data,
                dataType: 'json'

            }).done(function(response) {

                if(response) {
                    $('.exhibitors-wrapper').append(response.exhibitors_list);
                    $('.exhibitors-filter-wrapper').append(response.exhibitors_filter);

                    if($(response.exhibitors_list).filter('.exhibitors-container').length > 1) {
                        $('.exhibitors-nav').removeClass('hidden');
                    }

                    $.getScript(base_url + '/js/exhibitors.min.js', function() {
                        openPopupExhibitorInHash();
                    });

                } else {
                    $('.exhibitor-section').css('height', '100px');
                    $('.exhibitor-nav').css('visibility', 'hidden');
                    $('.exhibitor-wrapper').append('<p class="to-be-announced">'+translate('common.to-be-announced')+'.</p>');
                }

            }).always(function() {
                $loading.addClass('hidden');
            });
        }

    };


    var loadSeminars = function(location) {

        var $seminars = $('#seminars'),
            url  = base_url + '/seminars';

        $.ajax({
            url: url,
            dataType: 'html'

        }).done(function(response) {

            if(response) {
                $('.seminars-wrapper').append(response);
                $.getScript(base_url + '/js/seminars.js');
            } else {
                $('.change-seminars-city').css('visibility', 'hidden');
                $('.seminars-wrapper').append('<p class="to-be-announced">'+translate('common.to-be-announced')+'.</p>');
            }

        }).always(function() {
            $seminars.find('.loading').removeClass('active');
        });

    };


    var loadSeminarsByLocation = function(location_id) {

        var $loadingSeminars  = $('#seminars .loading'),
            $seminars_wrapper = $('.seminars-wrapper'),
            $seminarsNav      = $('.seminars-nav');

        if(!$seminars_wrapper.data('loaded')) {

            $seminarsNav.hide();
            $loadingSeminars.addClass('active');

            $.ajax({
                url: base_url+'/seminars/'+location_id,
                dataType: 'html'

            }).done(function(response) {

                if(response) {
                    $seminars_wrapper.append(response);
                    $.getScript(base_url + '/js/seminars.js');

                    // add flag to not load seminars more than once
                    $seminars_wrapper.attr('data-loaded', true);

                    $seminarsNav.show();

                } else {
                    $seminars_wrapper.append('<p class="to-be-announced">'+translate('common.to-be-announced')+'.</p>');
                }

            }).always(function() {
                // remove loading animation
                $loadingSeminars.removeClass('active');

                // trigger resize to fix container height
                $window.trigger('resize');
            });

        }

    };


    /*
    var initExhibitorsFilter = function() {
        var $exhibitor        = $('.exhibitor'),
            $exhibitorH3      = $exhibitor.find('h3'),
            $exhibitorsFilter = $('#exhibitors-filter'),
            exhibitorLength   = $exhibitor.length,
            exhibitorSearch   = [];


        // Store first letters to do the search
        for (var i = 0; i < exhibitorLength; i++) {
            var txt = $.trim($exhibitorH3.eq(i).text())[0].toLowerCase();
            exhibitorSearch.push(txt);

            // Change the color of the letter on the filter
            $exhibitorsFilter.find('a:contains("'+txt+'")').addClass('has-content');
        }


        $exhibitorsFilter.on('click', 'a', function (e) {
            e.preventDefault();

            if (!$(this).hasClass('active')) {
                $(this).siblings().removeClass('active');
                $(this).addClass('active');

                var search = $(this).text().toLowerCase();
                if ($(this).attr('id') === 'exhibitors-all') {
                    $exhibitor.stop(true, true).slideDown(500);
                } else {
                    for (var i = 0; i < exhibitorLength; i++) {
                        if (search === exhibitorSearch[i]) {
                            $exhibitor.eq(i).stop(true, true).slideDown(500);
                        } else {
                            $exhibitor.eq(i).stop(true, true).slideUp(500);
                        }
                    }
                }

                // set carousel height
                setTimeout(function() {
                    var height             = $('#exhibitors').height(),
                        $carousel          = $('.carousel'),
                        $carouselNav       = $carousel.find('.carousel-nav'),
                        $carouselContainer = $carousel.find('.carousel-container');

                    $carousel.css('height', $carouselNav.outerHeight() + height);
                    $carouselContainer.css('height', height);
                }, 510);
            }
        });
    };*/


    var initEmailSubscribe = function(form) {
        var $form          = form,
            $form_response = $form.prevAll('.form-response'),
            $form_loading  = $form.prevAll('.form-loading');

        $form.validate({
            rules : {
                name: { required: true },
                email : { required: true, email: true }
            },
            messages : {
                name : {
                    required: translate('validations.fields_required')
                },
                email : {
                    required: translate('validations.fields_required'),
                    email: translate('validations.valid_email')
                }
            },
            errorPlacement: function(error, element) {
                $form_response.empty().addClass('error').append(error.text());
            },
            submitHandler: function(form) {
                $form.hide();
                $form_loading.addClass('active');
                $form_response.empty().removeClass('error');

                $.ajax({
                    url: base_url + '/newsletter/exhibitor',
                    data: $form.serialize()

                }).done(function(response) {

                    if (response.status == 'success') {
                        form.reset();
                        $form_response.append(response.message);
                    } else {
                        $form_response.append(response.message).addClass('error');
                    }

                }).fail(function(jqXHR, textStatus, errorThrown) {
                    $form_response.append(translate('validations.try-again'));

                }).always(function(jqXHR, textStatus, errorThrown ) {
                    $form_loading.removeClass('active');
                    $form.show();
                });
            }
        });

        // NOTE: doesn't work unless inside setTimeout. find out why.
        setTimeout(function() {
            $form.find('[data-type="google_autocomplete"]:first').rules('add', 'required');
        }, 500);
    };


    /********************
     * EVENTS
     ********************/
    /**
     * Open exhibitor popup
     */
    $('.exhibitor-wrapper, .exhibitors-wrapper').on('click', '.open-exhibitor-popup', function(e) {
        e.preventDefault();
        loadExhibitor($(this).parents('[data-exhibitor-id]').data('exhibitor-id'));
    });


    /**
     * Close exhibitor popup
     */
    $('.exhibitor-section, .exhibitors-wrapper').on('click', '.close-exhibitor-popup', function(e) {
        e.preventDefault();
        if ($ePopupActive !== undefined) {
            $ePopupActive.removeClass('active');
        }

        $body.removeClass('no-scroll');
        $overlay.removeClass('active');
    });


    /**
     * Close exhibitor popup
     */
    $overlay.on('click', function (e) {
        e.preventDefault();
        if ($ePopupActive !== undefined) {
            $ePopupActive.removeClass('active');
        }
    });


    /**
     * Form on exhibitors popup
     */
    $('.exhibitor-section, .exhibitors-wrapper').on('submit', '.form-school-location', function(e) {
        e.preventDefault();
    });


    /**
     * Show the list of countries where an exhibitor is present
     */
    /*$('#exhibitors').on('click', '.open-exhibitor-cities', function(e) {
        e.preventDefault();
        e.stopPropagation();

        var $this = $(this);

        $this.toggleClass('active');
        $this.next('.exhibitors-other-cities').stop(true, true).slideToggle(400);
    });*/


    /**
     * Close the list of countries where an exhibitor is present
     */
    /*$('body').on('click', function () {
        var $actives = $('.open-exhibitor-cities.active');
        $actives.removeClass('active');

        for(var i=0, max=$actives.length; i<max; i++) {
            $actives.eq(i).next().stop(true, true).slideUp(400);
        }
    });*/


    /**
     * Load exhibitors on the location page
     */
    // $('#nav, .carousel-nav').on('click', '.load-exhibitors', function(e) {
    //     e.preventDefault();
    //     loadExhibitorsByLocation($('[data-location-id]').data('locationId'));
    // });


    /**
     * Load seminars on the location page
     */
    // $('#nav, .carousel-nav').on('click', '.load-seminars', function(e) {
    //     e.preventDefault();
    //     loadSeminarsByLocation($('[data-location-id]').data('locationId'));
    // });


    /**
     * Load exhibitors / seminars on page load
     */
    $window.on('load', function() {
        var virtual_fair_id = $('[data-virtual-fair-id]:first').data('virtual-fair-id');

        if ($('[data-page]').data('page') === 'home')
            loadExhibitors(virtual_fair_id);

        /*
        if (page === 'home') {
            loadExhibitors();
            loadSeminars();

        } else if (page === 'city') {
            var hash = window.location.hash;

            if(hash === '#goto_seminars') {
                $('[data-target="item-seminars"]:first').click();
                //loadSeminarsByLocation($('[data-location-id]').data('locationId'));

            } else if(hash === '#goto_exhibitors') {
                $('[data-target="item-exhibitors"]:first').click();
                //loadExhibitorsByLocation($('[data-location-id]').data('locationId'));

            } else {
                $('.carousel .change-carousel:first').click();
            }
        }
        */
    });


    /**
     * Exhibitor Popup
     * - Display the overlay and loading animation
     */
    function preOpenPopupExhibitor() {
        $overlay.addClass('active');
        $body.addClass('no-scroll');
        $loading.addClass('active');
    }

    /**
     * Exhibitor Popup
     * - Show the popup
     */
    function openPopupExhibitor() {
        $loading.removeClass('active');
        $('.exhibitor-popup').removeClass('active');
        $ePopup.addClass('active');
        $ePopupActive = $ePopup;
    }

    /**
     * If there's an exhibitor id in hash, open its popup
     */
    function openPopupExhibitorInHash() {
        var intervalID;

        // wait until the click event is attached to the "next" button
        intervalID = window.setInterval(function() {
            var events = $._data($('.exhibitors-next')[0], 'events');

            if (events.hasOwnProperty('click')) {
                clearInterval(intervalID);
                doOpenPopupExhibitorInHash();
            }
        }, 10);
    }

    function doOpenPopupExhibitorInHash() {
        var hash = (window.location.hash).replace('#', ''),
            open = /exhibitor\d+/.test(hash);

        if (open) {
            var id = hash.replace('exhibitor', ''),
                $exhibitor = $('[data-exhibitor-id="'+id+'"]');

            if ($exhibitor.length) {
                var $exhibitorContainer = $exhibitor.parent('.exhibitors-container');

                // force click on 'next' until we reach the exhibitor's page
                for (var i = $exhibitorContainer.index(); i > 0; i--) {
                    $('.exhibitors-next').click();
                }

                $exhibitor.find('.open-exhibitor-popup').click();
            }
        }
    }

});

//# sourceMappingURL=base.min.js.map
